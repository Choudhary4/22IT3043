# URL Shortener Microservice

A production-ready URL shortener microservice built with Node.js, Express, and MongoDB. Features include custom shortcodes, click tracking, automatic expiry, comprehensive logging integration with AffordMed test server, and Docker support.

## üöÄ Quick Start

### Prerequisites

- Node.js (‚â•16.0.0) 
- Yarn (‚â•1.22.0)
- MongoDB (‚â•4.4) or Docker
- Git

### Local Development Setup

1. **Clone and navigate to the repository:**
   ```bash
   git clone <repository-url>
   cd url-shortener-microservice
   ```

2. **Install dependencies:**
   ```bash
   yarn install
   ```

3. **Set up environment variables:**
   ```bash
   cp .env.example .env
   # Edit .env with your specific configuration if needed
   ```

4. **Start MongoDB** (if running locally):
   ```bash
   # On Windows with MongoDB installed\n   net start MongoDB\n   # On macOS with Homebrew\n   brew services start mongodb-community\n   # On Linux\n   sudo systemctl start mongod\n   ```

5. **Run the development server:**
   ```bash\n   yarn dev\n   ```\n\n6. **Verify the service is running:**\n   - Health check: http://localhost:3000/health\n   - API docs: http://localhost:3000/api/docs\n\n### Docker Setup (Recommended)\n\nThe easiest way to run the complete application with MongoDB:\n\n1. **Production setup:**\n   ```bash\n   docker-compose up -d\n   ```\n\n2. **Development setup with hot reload:**\n   ```bash\n   docker-compose -f docker-compose.dev.yml up -d\n   ```\n\n3. **View logs:**\n   ```bash\n   docker-compose logs -f app\n   ```\n\n4. **Stop services:**\n   ```bash\n   docker-compose down\n   ```\n\n## üìñ API Documentation\n\n### Base URL\n```\nhttp://localhost:3000\n```\n\n### Endpoints\n\n#### 1. Create Short URL\n\n**POST /shorturls**\n\nCreate a shortened URL with optional custom shortcode and validity period.\n\n**Request Body:**\n```json\n{\n  \"url\": \"https://www.example.com\",     // Required: Full URL with protocol\n  \"validity\": 60,                       // Optional: Minutes (default: 30)\n  \"shortcode\": \"myCustomCode\"           // Optional: 4-20 alphanumeric chars\n}\n```\n\n**Response (201):**\n```json\n{\n  \"shortLink\": \"http://localhost:3000/abc123\",\n  \"expiry\": \"2023-12-25T15:30:00.000Z\"\n}\n```\n\n**Error Responses:**\n- `400`: Invalid URL format, missing protocol, invalid validity\n- `409`: Custom shortcode already taken\n- `500`: Internal server error\n\n#### 2. Redirect to Original URL\n\n**GET /:shortcode**\n\nRedirect to the original URL and record click analytics.\n\n**Response:**\n- `302`: Redirect to original URL\n- `404`: Shortcode not found\n- `410`: Link expired\n- `500`: Internal server error\n\n#### 3. Get URL Statistics\n\n**GET /shorturls/:shortcode**\n\nRetrieve detailed statistics and click history for a shortcode.\n\n**Query Parameters:**\n- `page`: Page number for clicks pagination (default: 1)\n- `limit`: Items per page (default: 50, max: 1000)\n\n**Response (200):**\n```json\n{\n  \"shortcode\": \"abc123\",\n  \"originalUrl\": \"https://www.example.com\",\n  \"createdAt\": \"2023-12-25T14:00:00.000Z\",\n  \"expiry\": \"2023-12-25T15:30:00.000Z\",\n  \"totalClicks\": 5,\n  \"clicks\": [\n    {\n      \"ts\": \"2023-12-25T14:15:00.000Z\",\n      \"ip\": \"192.168.1.100\",\n      \"referrer\": \"https://google.com\",\n      \"userAgent\": \"Mozilla/5.0...\",\n      \"country\": \"US\"\n    }\n  ]\n}\n```\n\n**Error Responses:**\n- `404`: Shortcode not found\n- `400`: Invalid pagination parameters\n- `500`: Internal server error\n\n### Health Check\n\n**GET /health**\n\nService health status and uptime information.\n\n**Response (200):**\n```json\n{\n  \"status\": \"OK\",\n  \"timestamp\": \"2023-12-25T14:00:00.000Z\",\n  \"uptime\": 3600,\n  \"environment\": \"development\",\n  \"version\": \"1.0.0\"\n}\n```\n\n## üîß Example Usage\n\n### Using cURL\n\n1. **Create a short URL:**\n   ```bash\n   curl -X POST http://localhost:3000/shorturls \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\n       \"url\": \"https://www.github.com\",\n       \"validity\": 120,\n       \"shortcode\": \"github1\"\n     }'\n   ```\n\n2. **Access the short URL:**\n   ```bash\n   curl -L http://localhost:3000/github1\n   ```\n\n3. **Get statistics:**\n   ```bash\n   curl http://localhost:3000/shorturls/github1\n   ```\n\n4. **Get paginated statistics:**\n   ```bash\n   curl \"http://localhost:3000/shorturls/github1?page=1&limit=10\"\n   ```\n\n### Using JavaScript/Fetch\n\n```javascript\n// Create short URL\nconst response = await fetch('http://localhost:3000/shorturls', {\n  method: 'POST',\n  headers: { 'Content-Type': 'application/json' },\n  body: JSON.stringify({\n    url: 'https://www.stackoverflow.com',\n    validity: 60\n  })\n});\nconst result = await response.json();\nconsole.log(result.shortLink);\n\n// Get statistics\nconst statsResponse = await fetch(`http://localhost:3000/shorturls/abc123`);\nconst stats = await statsResponse.json();\nconsole.log(`Total clicks: ${stats.totalClicks}`);\n```\n\n## üß™ Testing\n\n### Running Tests\n\n```bash\n# Run all tests\nyarn test\n\n# Run tests in watch mode\nyarn test:watch\n\n# Run tests with coverage\nyarn test --coverage\n```\n\n### Test Coverage\n\nThe test suite includes:\n- Unit tests for core services (shortcode generation, validation)\n- Integration tests for all API endpoints\n- Error handling and edge cases\n- Rate limiting behavior\n- Complete workflow testing (create ‚Üí redirect ‚Üí stats)\n\n### Test Database\n\nTests use a separate test database (`urlshortener_test`) to avoid conflicts with development data.\n\n## üì¨ Postman Collection\n\n### Setup\n\n1. **Import the collection:**\n   - Import `postman/UrlShortener.postman_collection.json`\n   - Import `postman/UrlShortener.postman_environment.json`\n\n2. **Configure environment:**\n   - Select \"URL Shortener Environment\"\n   - Update `baseUrl` if running on different host/port\n   - Logging credentials are pre-configured for AffordMed test server\n\n3. **Automatic authentication:**\n   - The collection includes pre-request scripts for automatic token refresh\n   - Auth tokens are cached and renewed when expired\n   - No manual token management required\n\n### Available Requests\n\n**Authentication:**\n- Get Auth Token (manual authentication test)\n\n**URL Shortener API:**\n- Health Check\n- API Documentation\n- Create Short URL (various scenarios)\n- Redirect tests\n- Statistics retrieval\n- Error case validation\n\n**Logging Service:**\n- Send Log Entry (demonstrates AffordMed integration)\n\n### Environment Variables\n\nThe environment includes all necessary variables:\n- `baseUrl`: Service URL\n- `LOG_*`: AffordMed logging credentials\n- `authToken`: Auto-managed authentication token\n- Dynamic variables for test data sharing\n\n## üõ†Ô∏è Development\n\n### Project Structure\n\n```\nsrc/\n‚îú‚îÄ‚îÄ config/\n‚îÇ   ‚îú‚îÄ‚îÄ index.js          # Configuration management\n‚îÇ   ‚îî‚îÄ‚îÄ database.js       # MongoDB connection\n‚îú‚îÄ‚îÄ models/\n‚îÇ   ‚îî‚îÄ‚îÄ Url.js           # URL data model\n‚îú‚îÄ‚îÄ routes/\n‚îÇ   ‚îî‚îÄ‚îÄ urlRoutes.js     # API route handlers\n‚îú‚îÄ‚îÄ services/\n‚îÇ   ‚îú‚îÄ‚îÄ loggingClient.js # AffordMed logging integration\n‚îÇ   ‚îî‚îÄ‚îÄ shortcodeService.js # Shortcode generation\n‚îú‚îÄ‚îÄ middleware/\n‚îÇ   ‚îú‚îÄ‚îÄ errorHandler.js  # Error handling\n‚îÇ   ‚îî‚îÄ‚îÄ rateLimiter.js   # Rate limiting\n‚îú‚îÄ‚îÄ utils/\n‚îÇ   ‚îî‚îÄ‚îÄ validation.js    # Input validation utilities\n‚îî‚îÄ‚îÄ server.js            # Main application entry\n```\n\n### Available Scripts\n\n```bash\nyarn start      # Production server\nyarn dev        # Development with nodemon\nyarn test       # Run test suite\nyarn lint       # ESLint code checking\nyarn lint:fix   # Auto-fix linting issues\n```\n\n### Environment Variables\n\nCreate `.env` from `.env.example` and configure:\n\n```env\n# Server Configuration\nPORT=3000\nHOSTNAME=http://localhost:3000\n\n# Database\nMONGO_URL=mongodb://localhost:27017/urlshortener\n\n# AffordMed Logging (Required)\nLOG_AUTH_URL=http://20.244.56.144/evaluation-service/auth\nLOGS_URL=http://20.244.56.144/evaluation-service/logs\nLOG_ACCESS_CODE=xgAsNC\nLOG_CLIENT_ID=d9cbb699-6a27-44a5-8d59-8b1befa816da\nLOG_CLIENT_SECRET=tVJaaaRBSeXcRXeM\nLOG_EMAIL=ramkrishna@abc.edu\nLOG_NAME=\"ram krishna\"\nLOG_ROLLNO=aa1bb\n```\n\n### Code Quality\n\nThe project includes:\n- ESLint configuration for code standards\n- Comprehensive error handling\n- Input validation and sanitization\n- Security middleware (Helmet, CORS)\n- Rate limiting protection\n- Detailed logging\n\n## üöÄ Production Deployment\n\n### Docker Production\n\n```bash\n# Build and run production containers\ndocker-compose up -d\n\n# View production logs\ndocker-compose logs -f\n\n# Scale the application\ndocker-compose up -d --scale app=3\n```\n\n### Environment Considerations\n\n1. **Database:** Use MongoDB Atlas or managed instance\n2. **Environment Variables:** Set production values\n3. **Logging:** Configure log aggregation\n4. **Monitoring:** Add health check endpoints\n5. **Security:** Use HTTPS, proper CORS configuration\n6. **Scaling:** Consider load balancer and multiple instances\n\n### Performance\n\n- MongoDB indexes for fast lookups\n- Connection pooling for database efficiency\n- Rate limiting to prevent abuse\n- TTL indexes for automatic cleanup\n- Efficient base62 encoding\n\n## üîí Security Features\n\n- **Input Validation:** Strict URL and parameter validation\n- **SSRF Protection:** Blocks private IP ranges and localhost\n- **Rate Limiting:** Prevents abuse and DoS attacks\n- **Security Headers:** Helmet.js for security headers\n- **Error Handling:** No sensitive information leakage\n- **Docker Security:** Non-root user, minimal image\n\n## üìä Monitoring & Logging\n\n### Built-in Monitoring\n\n- Health check endpoint (`/health`)\n- Request logging with timing\n- Error tracking and reporting\n- Database connection monitoring\n\n### AffordMed Integration\n\nThe service integrates with AffordMed evaluation server for:\n- Authentication and authorization\n- Centralized logging\n- Event tracking\n- Performance monitoring\n\nLogs are sent for:\n- URL creation events\n- Redirect activities\n- Error conditions\n- System events\n\n## üêõ Troubleshooting\n\n### Common Issues\n\n1. **Database Connection Failed**\n   ```bash\n   # Check MongoDB status\n   docker-compose ps mongo\n   # View database logs\n   docker-compose logs mongo\n   ```\n\n2. **Port Already in Use**\n   ```bash\n   # Find process using port 3000\n   netstat -ano | findstr :3000\n   # Kill the process or change PORT in .env\n   ```\n\n3. **Tests Failing**\n   ```bash\n   # Ensure test database is accessible\n   # Check MongoDB is running\n   # Verify environment variables\n   ```\n\n4. **Logging Issues**\n   ```bash\n   # Check AffordMed service availability\n   curl http://20.244.56.144/evaluation-service/auth\n   # Verify credentials in .env\n   ```\n\n### Debug Mode\n\n```bash\n# Enable debug logging\nDEBUG=* yarn dev\n\n# MongoDB debug\nDEBUG=mongoose:* yarn dev\n```\n\n## üìù Contributing\n\n1. Fork the repository\n2. Create a feature branch: `git checkout -b feature/amazing-feature`\n3. Make changes and add tests\n4. Ensure tests pass: `yarn test`\n5. Commit changes: `git commit -m 'Add amazing feature'`\n6. Push to branch: `git push origin feature/amazing-feature`\n7. Submit a Pull Request\n\n### Development Guidelines\n\n- Follow existing code style (ESLint configuration)\n- Add tests for new features\n- Update documentation for API changes\n- Use meaningful commit messages\n- Keep functions small and focused\n\n## üìÑ License\n\nThis project is licensed under the MIT License - see the LICENSE file for details.\n\n## üôè Acknowledgments\n\n- AffordMed evaluation service for logging integration\n- MongoDB team for excellent documentation\n- Express.js community for middleware ecosystem\n- All contributors and testers\n\n---\n\n**For more detailed technical information, see [DESIGN.md](./DESIGN.md)**"